<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Grab from Behind — Word Chain</title>
  <meta name="theme-color" content="#eef3ff"/>
  <style>
    /* =========================
       Cupertino‑cute design tokens
       ========================= */
    :root{
      /* Neutrals */
      --ink: #111418;
      --ink-soft: #58616d;
      --surface: #ffffff;
      --glass: rgba(255,255,255,.74);
      --border: rgba(15, 23, 42, 0.08);

      /* Accents (Apple‑ish blue with a mint friend) */
      --accent: #0A84FF;      /* iOS Blue */
      --accent-600: #0076F5;
      --accent-100: #e6f0ff;
      --mint: #30d7a9;
      --rose: #ff7aa8;

      /* Background candy fog */
      --bg-1:#eef3ff;
      --bg-2:#fdf2ff;
      --bg-3:#effcf6;

      /* Radii & effects */
      --r-xl: 24px;
      --r-lg: 16px;
      --r-md: 12px;
      --blur: 20px;

      --shadow-1:
        0 1px 0 rgba(255,255,255,.9) inset,
        0 8px 30px rgba(10,132,255,.10),
        0 10px 24px rgba(0,0,0,.06);
      --shadow-2:
        0 2px 0 rgba(255,255,255,.95) inset,
        0 18px 46px rgba(10,132,255,.16),
        0 12px 28px rgba(0,0,0,.10);

      --ring: rgba(10,132,255,.35);
    }

    /* Base reset */
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      font: 500 16px ui-rounded, "SF Pro Rounded", "SF Pro Text", -apple-system, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:var(--ink);
      background:
        radial-gradient(1200px 1200px at 10% -10%, var(--bg-1) 0%, transparent 55%),
        radial-gradient(1100px 900px at 110% 0%, var(--bg-2) 0%, transparent 55%),
        radial-gradient(1000px 1000px at 50% 120%, var(--bg-3) 0%, transparent 60%),
        linear-gradient(#fff,#fff);
      background-attachment: fixed;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }

    .stage{
      min-height:100%;
      display:grid;
      place-items:center;
      padding: 28px 16px;
    }

    /* Card */
    .card{
      width:min(860px, 94vw);
      background: var(--glass);
      backdrop-filter: blur(var(--blur)) saturate(1.18);
      -webkit-backdrop-filter: blur(var(--blur)) saturate(1.18);
      border: 1px solid var(--border);
      border-radius: var(--r-xl);
      box-shadow: var(--shadow-1);
      overflow:hidden;
      transition: box-shadow .25s ease, transform .25s ease;
      transform-style: preserve-3d;
    }
    .card:hover{ box-shadow: var(--shadow-2) }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding: 16px 18px 0 18px;
    }
    .id{
      display:flex; align-items:center; gap:10px;
    }
    .dot{
      width:12px; height:12px; border-radius:50%;
      background: conic-gradient(from 180deg, #9cc5ff, #caa8ff, #b8f7e6, #9cc5ff);
      box-shadow: 0 8px 20px rgba(0,0,0,.08);
    }
    .badge{
      font: 800 12px/1 ui-rounded, inherit;
      padding:8px 12px; border-radius:999px;
      background: linear-gradient(180deg, #fff, #f6f8ff);
      border:1px solid var(--border);
      color: var(--accent-600);
      letter-spacing:.04em; text-transform:uppercase;
      box-shadow: 0 1px 0 rgba(255,255,255,.9) inset;
    }

    .inner{
      padding: clamp(18px, 3.6vw, 28px);
      padding-top: 12px;
    }

    h1{
      margin: 6px 0 6px;
      font-size: clamp(26px, 4.6vw, 42px);
      line-height: 1.08;
      letter-spacing: -0.02em;
    }
    .sub{
      color: var(--ink-soft);
      margin: 0 0 8px;
      font-size: clamp(14px, 2.6vw, 18px);
    }

    /* Chain row */
    .chain{
      display:flex; align-items:center; gap:8px;
      padding: 10px; border-radius: var(--r-lg);
      background: linear-gradient(180deg, #fff, #fafbff);
      border:1px solid var(--border);
      overflow:auto;
      scrollbar-width:none;
    }
    .chain::-webkit-scrollbar{ display:none }
    .chip{
      flex: 0 0 auto;
      padding: 8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight: 700;
      letter-spacing:.01em;
      color:#233047;
    }
    .chip.accent{
      background: var(--accent-100);
      border-color: rgba(10,132,255,.22);
      color: var(--accent-600);
    }
    .arrow{
      color:#a0a7b4; font-weight:800; padding:0 2px;
    }

    /* Play zone */
    .play{
      margin-top: 16px;
      display:grid; gap: 14px;
      grid-template-columns: 1fr;
    }

    .rule{
      display:flex; align-items:center; gap:10px;
      color: var(--ink-soft);
      font-size: 15px;
    }
    .bubble{
      display:inline-grid; place-items:center;
      width:28px; height:28px; border-radius:10px;
      background: #eef5ff;
      color: var(--accent-600);
      font-weight: 900;
      box-shadow: 0 1px 0 rgba(255,255,255,.9) inset;
      border: 1px solid rgba(10,132,255,.22);
    }

    .io{
      display:flex; gap:10px; align-items:stretch;
    }
    .input{
      flex:1;
      display:flex; align-items:center; gap:8px;
      background:#fff;
      border:1px solid var(--border);
      border-radius: 999px;
      padding: 8px 12px 8px 14px;
      box-shadow: 0 1px 0 rgba(255,255,255,.9) inset;
    }
    .input input{
      all:unset; flex:1;
      font: 700 18px/1.2 ui-rounded, inherit;
      letter-spacing:.02em;
      color:#1a2638;
    }
    .input:focus-within{
      box-shadow: 0 0 0 6px var(--ring), 0 1px 0 rgba(255,255,255,.9) inset;
      border-color: rgba(10,132,255,.26);
    }

    .btn{
      --bg:#fff; --bg2:#f7f9ff; --fg:var(--ink);
      appearance:none; border:1px solid var(--border);
      border-radius: 14px;
      background: linear-gradient(180deg, var(--bg), var(--bg2));
      color: var(--fg);
      font-weight: 800; letter-spacing:.01em;
      padding: 12px 16px;
      display:inline-flex; align-items:center; gap:10px;
      cursor:pointer;
      box-shadow: var(--shadow-1);
      transition: transform .12s ease, box-shadow .18s ease, filter .18s ease;
      user-select:none; -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ transform: translateY(-1px) }
    .btn:active{ transform: translateY(1px) scale(.985) }
    .btn:focus-visible{ outline:none; box-shadow: var(--shadow-2), 0 0 0 6px var(--ring) }

    .btn-primary{
      --bg: color-mix(in oklab, #fff 84%, var(--accent) 16%);
      --bg2: color-mix(in oklab, #fff 80%, var(--accent) 20%);
      --fg: #0e2550;
      border-color: rgba(10,132,255,.28);
    }

    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }

    /* Timer (clean circular) */
    .timer{
      position: relative;
      width: 52px; height: 52px; flex: 0 0 auto;
      border-radius: 50%;
      background:
        conic-gradient(var(--accent) var(--deg, 0deg), rgba(10,132,255,.15) 0deg);
      display:grid; place-items:center;
      transition: background .15s linear;
    }
    .timer::before{
      content:"";
      position:absolute; inset:6px; border-radius:50%;
      background: #fff;
      box-shadow: 0 1px 0 rgba(255,255,255,.9) inset;
    }
    .timer span{
      position:relative; z-index:1; font: 900 14px/1 ui-rounded, inherit; color:#0e2550;
    }

    /* Help text & error */
    .hint{ color:var(--ink-soft); font-size:13px }
    .err{ color:#b4232b; font-weight:800; opacity:0; transform:translateY(-4px); transition: .18s ease }
    .err.show{ opacity:1; transform:translateY(0) }
    .shake{ animation: shake .28s linear }
    @keyframes shake{
      0%,100%{ transform:translateX(0) }
      25%{ transform:translateX(-3px) }
      75%{ transform:translateX(3px) }
    }

    /* Celebration confetti (subtle dots) */
    .confetti{
      position:absolute; inset:0; pointer-events:none; overflow:hidden; display:none; z-index:3;
    }
    .confetti.show{ display:block }
    .dotfx{
      position:absolute; top:100%;
      width: var(--s,8px); height: var(--s,8px); border-radius:50%;
      background: var(--c,#0A84FF); opacity:0.9;
      filter: blur(.2px);
      animation: rise var(--d,1600ms) ease-in forwards;
      animation-delay: var(--dl,0ms);
    }
    @keyframes rise{
      10%{ opacity:1 }
      100%{ transform: translateY(-120vh); opacity:0 }
    }

    /* Footer share row */
    .share{
      display:none; margin-top: 8px; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .share.show{ display:flex }
    .note{ color: var(--ink-soft); font-size:13px }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:22px; transform:translateX(-50%) translateY(16px);
      background:#111; color:#fff; padding:10px 14px; border-radius: 12px;
      box-shadow: 0 12px 28px rgba(0,0,0,.18);
      opacity:0; pointer-events:none; transition:.28s ease; z-index: 10; font-size:14px;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0) }

    .tiny{ margin-top:10px; color:#7c8696; font-size:12px; text-align:center }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      .card, .btn{ transition:none !important }
      .confetti, .timer{ transition:none !important }
    }

    @media (max-width: 420px){
      .timer{ width:48px; height:48px }
      .input input{ font-size:17px }
    }
  </style>
</head>
<body>
  <main class="stage">
    <section class="card" role="region" aria-label="Grab from Behind — Word Chain">
      <div class="topbar">
        <div class="id">
          <div class="dot" aria-hidden="true"></div>
          <span class="badge" aria-hidden="true">Word Chain</span>
        </div>
        <div class="badge" style="color:#0c7b64;background:linear-gradient(180deg,#fff,#f3fff9);border-color:rgba(48,215,169,.24)">Clean Mode</div>
      </div>

      <div class="inner">
        <h1>Grab from Behind</h1>
        <p class="sub">Add one word that starts with the last letter of the chain. Keep it flowing — then pass it on.</p>

        <!-- Chain view -->
        <div class="chain" id="chain" aria-live="polite"></div>

        <!-- Play area -->
        <div class="play">
          <div class="rule">
            <span>Start with</span>
            <span class="bubble" id="needLetter" aria-label="Required starting letter">?</span>
            <span class="hint" id="hint">Type a simple word. No spaces or symbols.</span>
          </div>

          <div class="io">
            <div class="timer" id="timer" aria-hidden="true"><span id="tleft">—</span></div>

            <div class="input" id="inputWrap">
              <input id="word" name="word" placeholder="Your word…" inputmode="latin" autocomplete="off" spellcheck="false" aria-label="Enter your word"/>
            </div>

            <button id="submit" class="btn btn-primary" aria-label="Submit word">
              <span aria-hidden="true">➤</span> Submit
            </button>
          </div>

          <div class="row">
            <span id="error" class="err" role="status" aria-live="polite">Invalid word</span>
          </div>
        </div>

        <!-- Confetti -->
        <div class="confetti" id="confetti" aria-hidden="true"></div>

        <!-- Share row -->
        <div class="share" id="share">
          <button class="btn btn-primary" id="shareBtn"><span aria-hidden="true">📤</span> Share forward</button>
          <button class="btn" id="copyBtn"><span aria-hidden="true">🔗</span> Copy link</button>
          <span class="note">Next person has a short timer — keep the chain alive!</span>
        </div>

        <p class="tiny">Tip: Keep it simple and kind. Meow meow.</p>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true">Copied!</div>

  <script>
    // ------------- State & helpers
    const chainEl = document.getElementById('chain');
    const needEl = document.getElementById('needLetter');
    const hintEl = document.getElementById('hint');
    const wordEl = document.getElementById('word');
    const submitEl = document.getElementById('submit');
    const errorEl = document.getElementById('error');
    const confettiEl = document.getElementById('confetti');
    const shareRow = document.getElementById('share');
    const shareBtn = document.getElementById('shareBtn');
    const copyBtn = document.getElementById('copyBtn');
    const toast = document.getElementById('toast');
    const timerWrap = document.getElementById('timer');
    const tleftEl = document.getElementById('tleft');

    const params = new URLSearchParams(location.search);
    const SEP = '-'; // chain separator
    const DEFAULT_TIMER = 25; // seconds for next person

    function parseChainParam(){
      const raw = params.get('c');
      if(!raw) return [];
      return raw.split(SEP).map(s => decodeURIComponent(s)).filter(Boolean);
    }

    function serializeChain(arr){
      return arr.map(w => encodeURIComponent(w)).join(SEP);
    }

    function lastLetter(word){
      const m = (word || '').match(/[a-zA-Z]$/);
      return m ? m[0].toLowerCase() : '';
    }

    function firstLetter(word){
      const m = (word || '').match(/^[a-zA-Z]/);
      return m ? m[0].toLowerCase() : '';
    }

    function cleanWord(v){
      return (v || '').trim().toLowerCase();
    }

    function isValidWord(word){
      return /^[a-z]{2,18}$/.test(word);
    }

    // ------------- Render chain
    let chain = parseChainParam();

    function renderChain(){
      chainEl.innerHTML = '';
      if(chain.length === 0){
        const empty = document.createElement('div');
        empty.className = 'chip';
        empty.textContent = 'Start any word';
        chainEl.appendChild(empty);
        needEl.textContent = '?';
        hintEl.textContent = 'Pick a starting word. Keep it wholesome.';
        return;
      }
      chain.forEach((w, i) => {
        const chip = document.createElement('div');
        chip.className = 'chip' + (i === chain.length - 1 ? ' accent' : '');
        chip.textContent = w;
        chainEl.appendChild(chip);
        if(i < chain.length - 1){
          const arrow = document.createElement('div');
          arrow.className = 'arrow';
          arrow.textContent = '→';
          chainEl.appendChild(arrow);
        }
      });
      const need = lastLetter(chain[chain.length - 1]) || '?';
      needEl.textContent = need.toUpperCase();
      hintEl.textContent = `Your word must start with “${need.toUpperCase()}”.`;
    }

    renderChain();

    // ------------- Timer logic (only for the "next person" session)
    let timerActive = false;
    let timerStart = 0;
    let timerTotal = 0;
    let rafId;

    function startTimer(seconds){
      timerTotal = Math.max(3, seconds|0);
      timerStart = performance.now();
      timerActive = true;
      timerWrap.setAttribute('aria-hidden','false');
      tick();
    }

    function stopTimer(){
      timerActive = false;
      cancelAnimationFrame(rafId);
    }

    function tick(){
      if(!timerActive) return;
      const now = performance.now();
      const elapsed = (now - timerStart) / 1000;
      const remain = Math.max(0, timerTotal - elapsed);
      const pct = Math.max(0, 1 - (elapsed / timerTotal));
      const deg = (pct * 360).toFixed(1) + 'deg';
      timerWrap.style.setProperty('--deg', deg);
      tleftEl.textContent = Math.ceil(remain).toString();
      if(remain <= 0){
        timerExpired();
        return;
      }
      rafId = requestAnimationFrame(tick);
    }

    function timerExpired(){
      stopTimer();
      tleftEl.textContent = '0';
      timerWrap.style.setProperty('--deg', '0deg');
      disablePlay('Time’s up! Share the chain so someone else can try.');
      shareRow.classList.add('show');
    }

    // If the URL contains t (timer), start it for this session
    const tParam = parseInt(params.get('t') || '0', 10);
    if(tParam > 0){
      startTimer(tParam);
    }else{
      timerWrap.setAttribute('aria-hidden','true');
      tleftEl.textContent = '—';
    }

    // ------------- Play actions
    function showError(msg){
      errorEl.textContent = msg;
      errorEl.classList.add('show');
      wordEl.classList.add('shake');
      setTimeout(() => wordEl.classList.remove('shake'), 280);
    }
    function clearError(){
      errorEl.classList.remove('show');
    }

    function disablePlay(reason){
      wordEl.disabled = true;
      submitEl.disabled = true;
      if(reason){
        hintEl.textContent = reason;
      }
    }

    function celebrate(){
      confettiEl.innerHTML = '';
      confettiEl.classList.add('show');
      const colors = ['#0A84FF','#30d7a9','#ff7aa8','#7b8cff','#9bf0d4'];
      const count = 26;
      for(let i=0;i<count;i++){
        const d = document.createElement('div');
        d.className = 'dotfx';
        const left = 6 + Math.random()*88;
        const size = 6 + Math.random()*6;
        const delay = Math.random()*500;
        const dur = 1400 + Math.random()*900;
        const c = colors[Math.random()*colors.length|0];
        d.style.left = left + '%';
        d.style.setProperty('--s', size + 'px');
        d.style.setProperty('--dl', delay + 'ms');
        d.style.setProperty('--d', dur + 'ms');
        d.style.setProperty('--c', c);
        confettiEl.appendChild(d);
      }
      setTimeout(() => confettiEl.classList.remove('show'), 2200);
    }

    function submitWord(){
      clearError();
      const raw = cleanWord(wordEl.value);
      if(!isValidWord(raw)){
        showError('Use 2–18 letters only.');
        return;
      }
      if(chain.length){
        const need = lastLetter(chain[chain.length - 1]);
        if(firstLetter(raw) !== need){
          showError(`Must start with “${need.toUpperCase()}”.`);
          return;
        }
      }
      // OK: add to chain
      chain.push(raw);
      renderChain();
      wordEl.value = '';
      celebrate();

      // Lock this turn and show share
      disablePlay('Great pick! Share the link to pass your turn.');
      shareRow.classList.add('show');
      stopTimer(); // if any
    }

    submitEl.addEventListener('click', submitWord);
    wordEl.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ submitWord() }
    });
    wordEl.addEventListener('input', clearError);

    // ------------- Share
    function buildShareURL(){
      const base = location.origin + location.pathname;
      const c = serializeChain(chain);
      const t = DEFAULT_TIMER;
      const url = `${base}?c=${c}&t=${t}`;
      return url;
    }

    async function showToast(msg='Copied!'){
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 1400);
    }

    shareBtn.addEventListener('click', async ()=>{
      const url = buildShareURL();
      const title = 'Grab from Behind — Word Chain';
      const text = `Your turn! Add one word starting with “${(lastLetter(chain[chain.length-1])||'?').toUpperCase()}”`;
      try{
        if(navigator.share){
          await navigator.share({ title, text, url });
        }else{
          await navigator.clipboard.writeText(url);
          showToast('Link copied!');
        }
      }catch(e){
        // user cancelled — no op
      }
    });

    copyBtn.addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(buildShareURL());
        showToast('Link copied!');
      }catch{
        showToast('Copy not available');
      }
    });

    // ------------- Initialize input placeholder and hint
    (function init(){
      if(chain.length){
        wordEl.placeholder = `Starts with “${lastLetter(chain[chain.length-1]).toUpperCase()}”…`;
        wordEl.focus();
      }else{
        wordEl.placeholder = 'Any nice word to begin…';
      }
      if(tParam > 0){
        hintEl.textContent = `You have ${tParam}s. Keep it flowing!`;
      }
    })();
  </script>
</body>
</html>